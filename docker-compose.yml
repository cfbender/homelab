version: "3.7"

networks:
  default:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.host_binding_ipv4: ${SERVER_IP}
    ipam:
      config:
        - subnet: 172.20.69.0/24

services:
  # https://hub.docker.com/r/netdata/netdata
  netdata:
    image: netdata/netdata
    container_name: netdata
    restart: unless-stopped
    hostname: ${NETDATA_HOST}
    environment:
      PGID: ${DOCKER_PGID}
      TZ: ${TZ}
    cap_add:
      - SYS_PTRACE
    security_opt:
      - apparmor:unconfined
    volumes:
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      default:
        ipv4_address: 172.20.69.6
    dns: ${SERVER_IP}

  # https://www.home-assistant.io/
  home:
    image: lscr.io/linuxserver/homeassistant
    container_name: home
    restart: unless-stopped
    network_mode: host
    environment:
      TZ: ${TZ}
      PUID: ${PUID}
      PGID: ${PGID}
    volumes:
      - ${CONFIG_DIR}/home:/config
      - /etc/localtime:/etc/localtime:ro
      - ./fail2ban:/fail2ban
    devices:
      - /dev/ttyUSB1:/dev/ttyUSB1
    dns: ${SERVER_IP}

  # https://github.com/esphome/esphome
  esphome:
    image: esphome/esphome
    container_name: esphome
    network_mode: host
    restart: unless-stopped
    environment:
      TZ: ${TZ}
    volumes:
      - ${CONFIG_DIR}/esphome:/config
    dns: ${SERVER_IP}

  # https://github.com/cdr/code-server
  code:
    image: lscr.io/linuxserver/code-server
    container_name: code
    restart: unless-stopped
    environment:
      TZ: ${TZ}
      PUID: ${PUID}
      PGID: ${PGID}
      SUDO_PASSWORD_HASH: ${CODE_SUDO_PASSWORD_HASH}
      PORT: ${CODE_PORT}
    volumes:
      - ${CONFIG_DIR}/code:/config
      - ${CODE_DIR}:/home/code
    networks:
      default:
        ipv4_address: 172.20.69.8
    dns: ${SERVER_IP}

  # https://github.com/cfbender/personal-site
  personal-site:
    build:
      context: ../personal-site
      dockerfile: Dockerfile
      args:
        - SHOW_DASHBOARD=true
    container_name: personal-site
    restart: unless-stopped
    environment:
      PORT: ${WWW_PORT}
      SECRET_KEY_BASE: ${SECRET_KEY_BASE}
      HOSTNAME: ${COOKIE_DOMAIN}
    networks:
      default:
        ipv4_address: 172.20.69.9
    dns: ${SERVER_IP}
    labels:
      com.centurylinklabs.watchtower.enable: "false"

  # https://registry.hub.docker.com/r/adguard/adguardhome
  adguard:
    image: adguard/adguardhome
    container_name: adguard
    restart: unless-stopped
    network_mode: host
    volumes:
      - ${DATA_DIR}/adguard:/opt/adguardhome/work
      - ${CONFIG_DIR}/adguard:/opt/adguardhome/conf
    dns: ${GATEWAY_IP}

  # https://github.com/bakito/adguardhome-sync/
  adguard-sync:
    image: lscr.io/linuxserver/adguardhome-sync
    restart: unless-stopped
    container_name: adguard-sync
    environment:
      PUID: ${PUID}
      PGID: ${PUID}
      TZ: ${TZ}
      CONFIGFILE: /config/adguardhome-sync.yaml
    volumes:
      - ${CONFIG_DIR}/adguard:/config
    ports:
      - 8090:8080
    networks:
      default:
        ipv4_address: 172.20.69.10
    dns: ${SERVER_IP}

  # https://github.com/thomseddon/traefik-forward-auth
  traefik-forward-auth:
    image: thomseddon/traefik-forward-auth:2
    container_name: traefik-forward-auth
    environment:
      - PROVIDERS_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - PROVIDERS_GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - SECRET=${AUTH_SECRET}
      - WHITELIST=${OAUTH_WHITELIST}
      - LOG_LEVEL=debug
      - AUTH_HOST=${AUTH_HOST}
      - COOKIE_DOMAIN=${COOKIE_DOMAIN}
    networks:
      default:
        ipv4_address: 172.20.69.11
    dns: ${SERVER_IP}

  # https://github.com/containrrr/watchtower/
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    environment:
      TZ: ${TZ}
      WATCHTOWER_NOTIFICATIONS: "shoutrrr"
      WATCHTOWER_NOTIFICATION_URL: ${WATCHTOWER_NOTIFICATION_URL}
      WATCHTOWER_CLEANUP: "true"
    command: --schedule "0 0 20 * * *" # runs daily at 8 PM
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      default:
        ipv4_address: 172.20.69.12
    dns: ${SERVER_IP}

  # https://github.com/portainer/portainer
  portainer:
    image: portainer/portainer-ce
    container_name: portainer
    restart: unless-stopped
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${DATA_DIR}/portainer:/data
    networks:
      default:
        ipv4_address: 172.20.69.13
    dns: ${SERVER_IP}

  # https://github.com/zwave-js/zwavejs2mqtt
  zwave:
    image: zwavejs/zwavejs2mqtt
    container_name: zwave
    restart: unless-stopped
    tty: true
    volumes:
      - ${DATA_DIR}/zwavejs2mqtt:/usr/src/app/store
    devices:
      - ${ZWAVE_SERIAL_PATH}:/dev/zwave
    ports:
      - 8484:3000
    networks:
      default:
        ipv4_address: 172.20.69.14
    dns: ${SERVER_IP}

  # https://github.com/linuxserver/docker-unifi-controller
  unifi:
    image: lscr.io/linuxserver/unifi-controller
    container_name: unifi
    restart: unless-stopped
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
    volumes:
      - ${CONFIG_DIR}/unifi:/config
    ports:
      - 3478:3478/udp
      - 10001:10001/udp
      - 8080:8080
      - 8443:8443
      - 6789:6789 # optional
    networks:
      default:
        ipv4_address: 172.20.69.15
    dns: ${SERVER_IP}

  # https://github.com/BookStackApp/BookStack
  bookstack:
    image: lscr.io/linuxserver/bookstack
    container_name: bookstack
    restart: unless-stopped
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      APP_URL: https://${BOOKSTACK_HOST}
      DB_HOST: bookstack_db
      DB_DATABASE: bookstackapp
      DB_USERNAME: ${BOOKSTACK_DB_USER}
      DB_PASSWORD: ${BOOKSTACK_DB_PASS}
    volumes:
      - ${DATA_DIR}/bookstack:/config
    depends_on:
      - bookstack_db
    networks:
      default:
        ipv4_address: 172.20.69.16
    dns: ${SERVER_IP}

  bookstack_db:
    image: lscr.io/linuxserver/mariadb
    container_name: bookstack_db
    restart: unless-stopped
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
      MYSQL_DATABASE: bookstackapp
      MYSQL_USER: ${BOOKSTACK_DB_USER}
      MYSQL_PASSWORD: ${BOOKSTACK_DB_PASS}
      MYSQL_ROOT_PASSWORD: ${BOOKSTACK_DB_ROOT_PASS}
    volumes:
      - ${DATA_DIR}/bookstack_db:/config
    networks:
      default:
        ipv4_address: 172.20.69.17
    dns: ${SERVER_IP}

  # https://github.com/linuxserver/docker-wireguard
  wireguard:
    image: lscr.io/linuxserver/wireguard
    container_name: wireguard
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      PUID: ${PUID}
      PGID: ${PGID}
      TZ: ${TZ}
      SERVERURL: ${WIREGUARD_HOST}
      SERVERPORT: 51820
      PEERS: 5
      PEERDNS: auto
    ports:
      - 51820:51820/udp
    volumes:
      - ${CONFIG_DIR}/wireguard:/config
      - /lib/modules:/lib/modules
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
    dns: ${SERVER_IP}

  mosquitto:
    image: eclipse-mosquitto
    container_name: mosquitto
    restart: unless-stopped
    environment:
      TZ: ${TZ}
    ports:
      - 1883:1883/tcp
      - 9001:9001/tcp
    volumes:
      - ${CONFIG_DIR}/mosquitto:/mosquitto/config
      - ${DATA_DIR}/mosquitto:/mosquitto/data
      - ${DATA_DIR}/mosquitto/log:/mosquitto/log
      - /etc/localtime:/etc/localtime:ro
    networks:
      default:
        ipv4_address: 172.20.69.18
    dns: ${SERVER_IP}

  fail2ban:
    image: crazymax/fail2ban:latest
    container_name: fail2ban
    network_mode: host
    environment:
      TZ: ${TZ}
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./fail2ban:/data
      - ./traefik/log/access.log:/var/log/access.log:ro
      - ${CONFIG_DIR}/home/home-assistant.log:/var/log/home-assistant.log:ro
      - /var/log/auth.log:/var/log/auth.log:ro
    dns: ${SERVER_IP}
