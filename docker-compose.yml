version: "3.7"

networks:
  default:

services:
  # https://hub.docker.com/r/netdata/netdata
  netdata:
    image: netdata/netdata
    restart: unless-stopped
    hostname: ${NETDATA_HOST}
    environment:
      PGID: ${DOCKER_PGID}
      TZ: ${TZ}
    cap_add:
      - SYS_PTRACE
    security_opt:
      - apparmor:unconfined
    volumes:
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - default
    dns:
      - 1.1.1.1
      - 1.0.0.1

  # https://www.home-assistant.io/
  home:
    image: lscr.io/linuxserver/homeassistant
    restart: unless-stopped
    network_mode: host
    environment:
      TZ: ${TZ}
      PUID: ${PUID}
      PGID: ${PGID}
    volumes:
      - ${CONFIG_DIR}/home:/config
      - /etc/localtime:/etc/localtime:ro
    dns:
      - 1.1.1.1
      - 1.0.0.1
    devices: 
      - /dev/ttyUSB0:/dev/ttyUSB0
      - /dev/ttyUSB1:/dev/ttyUSB1

  # https://github.com/esphome/esphome
  esphome:
    image: esphome/esphome
    restart: unless-stopped
    environment:
      TZ: ${TZ}
      ESPHOME_DASHBOARD_USE_PING: "true"
    volumes:
      - ${CONFIG_DIR}/esphome:/config
    networks:
      - default

  # https://github.com/cdr/code-server
  code:
    image: lscr.io/linuxserver/code-server
    restart: unless-stopped
    environment:
      TZ: ${TZ}
      PUID: ${PUID}
      PGID: ${PGID}
      SUDO_PASSWORD_HASH: ${CODE_SUDO_PASSWORD_HASH} 
    volumes:
      - ${CONFIG_DIR}/code:/config
      - ${CODE_DIR}:/home/code
    networks:
      - default
    dns:
      - 1.1.1.1
      - 1.0.0.1

  # https://github.com/cfbender/personal-site
  personal-site:
    build:
      context: ../personal-site
      dockerfile: Dockerfile
      args:
        - SHOW_DASHBOARD=true
    restart: unless-stopped
    environment:
      PORT: ${WWW_PORT}
      SECRET_KEY_BASE: ${SECRET_KEY_BASE}
      HOSTNAME: ${COOKIE_DOMAIN}
    networks:
      - default
    dns:
      - 1.1.1.1
      - 1.0.0.1

  # https://registry.hub.docker.com/r/adguard/adguardhome
  adguard:
    image: adguard/adguardhome
    restart: unless-stopped
    network_mode: host
    volumes:
      - ${DATA_DIR}/adguard:/opt/adguardhome/work
      - ${CONFIG_DIR}/adguard:/opt/adguardhome/conf
    ports:
      - "53:53/tcp"
      - "3000:3000/tcp"
    expose:
      - 53
    dns:
      - 1.1.1.1
      - 1.0.0.1

 # https://github.com/thomseddon/traefik-forward-auth
  traefik-forward-auth:
    image: thomseddon/traefik-forward-auth
    environment:
      - PROVIDERS_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - PROVIDERS_GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - SECRET=${AUTH_SECRET}
      - WHITELIST=${OAUTH_WHITELIST}
      - LOG_LEVEL=debug
      - AUTH_HOST=${AUTH_HOST}
      - COOKIE_DOMAIN=${COOKIE_DOMAIN}
    networks:
      - default
    dns:
      - 1.1.1.1
      - 1.0.0.1
  
  watchtower:
    image: containrrr/watchtower
    environment:
      WATCHTOWER_NOTIFICATIONS: "shoutrrr"
      WATCHTOWER_NOTIFICATION_URL: ${WATCHTOWER_NOTIFICATION_URL}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
