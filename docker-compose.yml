version: "3.7"

networks:
  default:

services:
  # https://hub.docker.com/r/netdata/netdata
  netdata:
    image: netdata/netdata@sha256:41f92ccb279ceb750bcaae2958b4fc13a425913a3e54b3d59324ccef118e4507
    restart: unless-stopped
    hostname: ${NETDATA_HOST}
    environment:
      PGID: ${DOCKER_PGID}
      TZ: ${TZ}
    cap_add:
      - SYS_PTRACE
    security_opt:
      - apparmor:unconfined
    volumes:
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - default

  # https://www.home-assistant.io/
  home:
    image: lscr.io/linuxserver/homeassistant@sha256:cac8fb5fe794934d88dcbfd0dbcda1ebc657319b5a0a057b7d8df0fb19d5d202
    restart: unless-stopped
    network_mode: host
    environment:
      TZ: ${TZ}
      PUID: ${PUID}
      PGID: ${PGID}
    volumes:
      - ${CONFIG_DIR}/home:/config
      - /etc/localtime:/etc/localtime:ro

  # https://github.com/esphome/esphome
  esphome:
    image: esphome/esphome@sha256:c29d71c7579cd988220ea551807b19d6354e6bfa3aa8bb37163671ce68e06ad0
    restart: unless-stopped
    environment:
      TZ: ${TZ}
      ESPHOME_DASHBOARD_USE_PING: "true"
    volumes:
      - ${CONFIG_DIR}/esphome:/config
    networks:
      - default

  # https://github.com/cdr/code-server
  code:
    image: lscr.io/linuxserver/code-server@sha256:ccb72549eec0546024cf19764d1acda0566f42e558c8badc3975226d8e909e33
    restart: unless-stopped
    environment:
      TZ: ${TZ}
      PUID: ${PUID}
      PGID: ${PGID}
      SUDO_PASSWORD_HASH: ${CODE_SUDO_PASSWORD_HASH} 
    volumes:
      - ${CONFIG_DIR}/code:/config
      - ${CODE_DIR}:/home/code
    networks:
      - default

  # https://github.com/cfbender/personal-site
  personal-site:
    build:
      context: ../personal-site
      dockerfile: Dockerfile
      args:
        - SHOW_DASHBOARD=true
    restart: unless-stopped
    environment:
      PORT: ${WWW_PORT}
      SECRET_KEY_BASE: ${SECRET_KEY_BASE}
      HOSTNAME: ${PERSONAL_SITE_HOST}
    networks:
      - default

  # https://registry.hub.docker.com/r/adguard/adguardhome
  adguard:
    image: adguard/adguardhome
    restart: unless-stopped
    network_mode: host
    volumes:
      - ${DATA_DIR}/adguard:/opt/adguardhome/work
      - ${CONFIG_DIR}/adguard:/opt/adguardhome/conf
    ports:
      - "53:53/tcp"
      - "3000:3000/tcp"
    expose:
      - 53

 # https://github.com/thomseddon/traefik-forward-auth
  traefik-forward-auth:
    image: thomseddon/traefik-forward-auth@sha256:69a2c985d2c518b6f0e77161a98628a148a5d964e4e84fc52cc62e19bb4da634
    environment:
      - PROVIDERS_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - PROVIDERS_GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - SECRET=${AUTH_SECRET}
      - WHITELIST=${OAUTH_WHITELIST}
      - LOG_LEVEL=debug
      - AUTH_HOST=${AUTH_HOST}
      - COOKIE_DOMAIN=${COOKIE_DOMAIN}
    networks:
      - default
